---
tags: [type/guide, dev/payment, methodology/workflow, status/completed]
created: 2026-02-05
---

# 키움페이 정기결제 연동 가이드

> 2026-02-05 테스트 완료 ✅

## 개요

키움페이(쿠키페이먼츠 API)를 통한 비인증 정기결제 연동 가이드.
빌링키 발급 → 결제 → 환불 전체 플로우. 
```

- **API URL (테스트):** `https://sandbox.cookiepayments.com`
- **API URL (운영):** `https://www.cookiepayments.com`

---

## 1. 사전 준비

### 1.1 쿠키페이먼츠 계정

1. [sandbox.cookiepayments.com](https://sandbox.cookiepayments.com) 회원가입
2. 로그인 → API 연동 → PG사 조회 및 연동설정
3. "비인증_정기" 결제수단에서 **키움페이** 확인
4. **연동ID**와 **연동 시크릿키** 복사

### 1.2 필요한 키

| 항목 | 예시 | 설명 |
|------|------|------|
| 연동ID (CPID) | `sandbox_2JdglQvKCb` | API_ID, pay2_id로 사용 |
| 시크릿키 (AUTH_KEY) | `sandbox_L5YPji...` | ApiKey 헤더, pay2_key로 사용 |

---

## 2. API 엔드포인트

| 기능 | 엔드포인트 | 메서드 |
|------|-----------|--------|
| 토큰 발급 | `/payAuth/token` | POST |
| 빌링키 발급 | `/Subscribe/billkeygen` | POST |
| 빌링키 결제 | `/Subscribe/payments` | POST |
| 결제 취소 | `/api/cancel` | POST |
| 데이터 복호화 | `/EdiAuth/cookiepay_edi_decrypt` | POST |

---

## 3. 인증 플로우

### 3.1 토큰 발급 (모든 API 호출 전 필수)

```javascript
// 요청
POST /payAuth/token
Content-Type: application/json

{
  "pay2_id": "연동ID",
  "pay2_key": "시크릿키"
}

// 응답
{
  "RTN_CD": "0000",
  "RTN_MSG": "성공",
  "TOKEN": "eyJ0eXAiOiJKV1Q..."
}
```

### 3.2 API 호출 시 헤더

```
Content-Type: application/json
ApiKey: {시크릿키}
TOKEN: {발급받은 토큰}
```

---

## 4. 빌링키 발급

### 4.1 요청

```javascript
POST /Subscribe/billkeygen
Headers: ApiKey, TOKEN

{
  "API_ID": "연동ID",
  "ORDERNO": "주문번호 (유니크)",
  "PRODUCTNAME": "상품명",
  "PRODUCTCODE": "상품코드",
  "CARDNO": "카드번호 16자리",
  "EXPIREDT": "YYMM",          // ⚠️ 년도가 먼저!
  "CARDPWD": "비밀번호 앞 2자리",
  "CARDAUTH": "YYMMDD",        // 생년월일 6자리
  "QUOTA": "00",               // 일시불
  "TAXFREECD": "Y",            // 과세
  "BUYERNAME": "구매자명",
  "BUYERID": "구매자ID"
}
```

### 4.2 응답 (암호화)

```javascript
{
  "RESULTCODE": "0000",
  "RESULTMSG": "성공",
  "ENC_DATA": "암호화된데이터..."
}
```

### 4.3 복호화 필요!

```javascript
POST /EdiAuth/cookiepay_edi_decrypt
Headers: ApiKey

{
  "API_ID": "연동ID",
  "ENC_DATA": "응답받은 ENC_DATA"
}

// 복호화 결과
{
  "RESULTCODE": "0000",
  "decryptData": {
    "BILLKEY": "발급된빌링키",  // ⭐ 저장 필수!
    "GENDATE": "20260205175940",
    "CARDCODE": "CCBC",
    "CARDNAME": "BC"
  }
}
```

---

## 5. 빌링키로 결제

### 5.1 요청

```javascript
POST /Subscribe/payments
Headers: ApiKey, TOKEN

{
  "API_ID": "연동ID",
  "BILLKEY": "발급받은빌링키",
  "ORDERNO": "주문번호 (유니크)",
  "PRODUCTNAME": "상품명",
  "PRODUCTCODE": "상품코드",
  "AMOUNT": "결제금액",        // 문자열!
  "TAXFREECD": "Y",            // ⚠️ 필수!
  "QUOTA": "00",
  "BUYERNAME": "구매자명",
  "BUYERID": "구매자ID"
}
```

### 5.2 응답 (암호화)

ENC_DATA 복호화하면:

```javascript
{
  "decryptData": {
    "RESULTCODE": "0000",
    "TID": "cTS26020517561297485",  // 거래번호 (환불시 필요)
    "ORDERNO": "PAY-20260205-...",
    "AMOUNT": "100",
    "ACCEPTDATE": "20260205175611",
    "ACCEPTNO": "43484979",
    "CARDNAME": "BC"
  }
}
```

---

## 6. 결제 취소 (환불)

### 6.1 요청

```javascript
POST /api/cancel
Headers: ApiKey, TOKEN

{
  "tid": "거래번호(TID)",     // 결제 응답의 TID
  "reason": "취소사유",
  "amount": "1000"            // 부분취소 시만 (선택)
}
```

### 6.2 응답

```javascript
{
  "cancel_code": "0000",
  "cancel_msg": "성공",
  "cancel_tid": "취소거래번호",
  "cancel_date": "20260205175953",
  "cancel_amt": "100"
}
```

---

## 7. 주의사항

### ⚠️ 중요 포인트

1. **테스트 카드번호 없음!**
   - 키움페이 sandbox는 **실제 카드**로만 테스트 가능
   - 당일 20시 이후 자동 취소됨

2. **유효기간 형식: YYMM**
   - ✅ 2028년 12월 → `2812`
   - ❌ `1228` (MMYY 아님!)

3. **TAXFREECD 필수**
   - 결제 시 `TAXFREECD: "Y"` (과세) 필수

4. **ENC_DATA 복호화**
   - 빌링키 발급, 결제 응답 모두 암호화됨
   - 반드시 `/EdiAuth/cookiepay_edi_decrypt`로 복호화

5. **토큰 유효시간**
   - 토큰은 1시간 유효 (추정)
   - 각 API 호출 전 토큰 재발급 권장

---

## 8. 에러 코드

| 코드 | 메시지 | 해결 |
|------|--------|------|
| 1012 | 미등록된 발급카드 거래불가 | 실제 카드 사용 |
| 2015 | 카드유효기간오류 | YYMM 형식 확인 |
| E007 | 필수 항목 누락 | 파라미터 확인 |

---

## 9. 레퍼런스 프로젝트

- **프로젝트:** `C:\JohnCodeQ\kiwoom-billing`
- **GitHub:** github.com/keyfream7001/kiwoom-billing
- **테스트 페이지:**
  - 빌링키 발급: `/test.html`
  - 결제: `/test-pay.html`
  - 환불: `/test-refund.html`

---

## 10. 문서 링크

- [쿠키페이먼츠 정기결제 문서](https://www.cookiepayments.com/docs/정기결제)
- [쿠키페이먼츠 결제취소 문서](https://www.cookiepayments.com/docs/결제취소)
- [키움페이 개발자센터](https://developer.kiwoompay.co.kr)
